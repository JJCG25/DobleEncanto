{% extends 'pedidos/base.html' %}
{% block title %}Historial de Pedidos{% endblock %}

{% block content %}

<div style="padding: 40px; display: flex; flex-direction: column; align-items: center; width: 100%">

    <!-- Formulario -->
    <form method="POST" style="
        width: 450px; 
        display:flex; 
        flex-direction:column; 
        gap:15px;
        margin-bottom:20px;
    ">
        {% csrf_token %}

        <label style="font-size:20px; font-weight:bold;">Cliente:</label>

        <select name="cliente" style="
            padding: 12px; 
            border-radius:10px; 
            border: 1px solid #bbb;
            font-size:16px;
            width:100%;
            background:white;
        ">
            <option value="">-- Selecciona un cliente --</option>
            {% for cliente in clientes %}
            <option value="{{ cliente.id }}"
                {% if cliente_seleccionado and cliente_seleccionado.id == cliente.id %}
                    selected
                {% endif %}
            >{{ cliente.nombre }}</option>
            {% endfor %}
        </select>

        <button type="submit" style="
            background-color:#cc8fa6;
            color:white;
            border:none;
            padding:15px;
            border-radius:35px;
            font-weight:bold;
            font-size:18px;
            cursor:pointer;
            width:60%;
            align-self:center;
            margin-top:10px;
            box-shadow:0 4px 8px rgba(0,0,0,0.15);
        ">
            Consultar Historial
        </button>
    </form>

    <!-- CONTENEDOR DE TABLA -->
    <div style="
        background-color:#cc8fa6; 
        padding:25px; 
        border-radius:12px; 
        width:80%; 
        margin-top:20px;
        box-shadow:0 4px 8px rgba(0,0,0,0.1);
        display:flex;
        justify-content:center;
    ">
        <div style="width:90%;">

            <h2 style="color:white; text-align:center; margin-bottom:20px; font-size:24px;">
                Historial de Pedidos
            </h2>

            <!-- TABLA -->
            <table style="
                width:100%; 
                background:white; 
                border-collapse:collapse; 
                border-radius:10px; 
                overflow:hidden;
                font-size:16px;
            ">
                <thead style="background-color:#f7e1ea; font-weight:bold;">
                    <tr>
                        <th style="padding:12px; text-align:center;">ID</th>
                        <th style="padding:12px; text-align:center;">Fecha</th>
                        <th style="padding:12px; text-align:center;">Productos</th>
                        <th style="padding:12px; text-align:center;">Total</th>
                        <th style="padding:12px; text-align:center;">Estado</th>
                    </tr>
                </thead>

                <tbody>
                {% if pedidos %}
                    {% for pedido in pedidos %}
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px; text-align:center;">P{{ pedido.id|stringformat:"03d" }}</td>
                        <td style="padding:10px; text-align:center;">
                            {{ pedido.fecha|date:"d/m/Y" }}
                        </td>
                        <td style="padding:10px; text-align:center;">
                            {% for det in pedido.detalles.all %}
                                {{ det.producto.nombre }} (x{{ det.cantidad }})<br>
                            {% endfor %}
                        </td>
                        <td style="padding:10px; text-align:center; font-weight:bold;">
                            <!-- LUEGO CALCULAMOS TOTAL REAL -->
                            {{ pedido.detalles.all|length }}
                        </td>
                        <td style="padding:10px; text-align:center;">
                            {{ pedido.get_estado_display }}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <!-- TABLA VACÃA -->
                    <tr>
                        <td colspan="5" style="padding:20px; text-align:center; color:#777;">
                            Selecciona un cliente para ver su historial.
                        </td>
                    </tr>
                {% endif %}
                </tbody>

            </table>

        </div>
    </div>

</div>

{% endblock %}
